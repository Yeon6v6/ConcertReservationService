---
icon: diagram-next
---

# 시퀀스 다이어그램

{% hint style="info" %}
**대기열 토큰 발급**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    사용자 ->> 토큰관리 : [1] 대기열 토큰 발급 요청
    opt 인증 실패
        토큰관리 -->> 사용자 : [2] 토큰 발급 실패 (인증 오류)
    end
    토큰관리 -->> 사용자 : [3] 대기열 토큰 발급 완료

```

***

{% hint style="info" %}
**대기열 토큰 검증**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    participant 대기열관리
    participant 데이터베이스

    사용자 ->> 토큰관리 : [1] 대기열 토큰 검증 요청
    alt 토큰 검증 실패
        토큰관리 -->> 사용자 : [2] 검증 실패 알림
    else
        토큰관리 ->> 토큰관리 : [3] 만료시간 갱신
    end

    사용자 ->> 대기열관리 : [4] 대기열 순번 조회 요청
    대기열관리 ->> 데이터베이스 : [5] 대기열 상태 및 순번 조회
    데이터베이스 -->> 대기열관리 : [6] 대기열 데이터 반환
    alt 대기열 정보 없음
        대기열관리 -->> 사용자 : [7] 대기열 정보 없음 알림
    else
        대기열관리 -->> 사용자 : [8] 대기순번 및 대기 상태 반환
    end

    사용자 ->> 사용자 : [9] 대기 정보 표시
```

***

{% hint style="info" %}
**예매 가능한 날짜 조회**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    participant 예약관리 
    participant 데이터베이스
    사용자 ->> 토큰관리 : [1] 대기열 토큰 검증 요청
    opt 토큰 검증 실패
        토큰관리 -->> 사용자 : [2] 검증 실패 알림
    end
    토큰관리 ->> 토큰관리 : [3] 만료시간 갱신
    사용자 ->> 예약관리 : [4] 예약 가능 날짜 조회 요청
    예약관리 ->> 데이터베이스 : [5] 예약 가능 날짜 조회
    데이터베이스 -->> 예약관리 : [6] 날짜 정보 반환
    예약관리 -->> 사용자 : [7] 예약 가능 날짜 전달


```

***

{% hint style="info" %}
**특정 날짜의 예매 가능 좌석 조회**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    participant 예약관리
    participant 데이터베이스
    사용자 ->> 토큰관리 : [1] 토큰 검증 요청
    opt 토큰 검증 실패
        토큰관리 -->> 사용자 : [2] 검증 실패 알림
    end
    토큰관리 ->> 토큰관리 : [3] 만료시간 갱신
    토큰관리 ->> 예약관리 : [4] 특정 날짜의 예매 가능 좌석 조회 요청
    예약관리 ->> 데이터베이스 : [5] 좌석 상태 조회
    데이터베이스 -->> 예약관리 : [6] 좌석 정보 반환
    예약관리 -->> 토큰관리 : [7] 좌석 상태 정보 전달
    토큰관리 -->> 사용자 : [8] 좌석 상태 정보 전달

```

***

{% hint style="info" %}
**좌석 예약 요청**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    participant 예매관리
    participant 데이터베이스

    사용자 ->> 토큰관리 : [1] 대기열 토큰 검증 요청
    opt 토큰 검증 실패
        토큰관리 -->> 사용자 : [2] 검증 실패 알림
    end
    토큰관리 -->> 사용자 : [3] 검증 성공 (토큰 유효)

    사용자 ->> 예매관리 : [4] 좌석 예약 요청
    예매관리 ->> 데이터베이스 : [5] 좌석 상태 확인
    opt 좌석 이미 예약됨
        데이터베이스 -->> 예매관리 : [6] 좌석 예약 실패
        예매관리 -->> 사용자 : [7] 좌석 예약 실패 알림 (이미 예약된 좌석)
    end

    예매관리 ->> 데이터베이스 : [8] 좌석 임시 예약 처리
    opt 좌석 임시 예약 실패
    데이터베이스 -->> 예매관리 : [9] 좌석 임시 예약 실패
        예매관리 -->> 사용자 : [10] 좌석 임시 예약 실패 알림
    end

    데이터베이스 -->> 예매관리 : [11] 좌석 임시 예약 성공
    예매관리 -->> 사용자 : [12] 좌석 예약 성공 알림

```

***

{% hint style="info" %}
**잔액 조회**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 결제관리
    participant 데이터베이스

    사용자 ->> 결제관리 : [1] 잔액 조회 요청
    결제관리 ->> 데이터베이스 : [2] 사용자 잔액 조회
    opt 잔액 조회 실패
        결제관리 -->> 사용자 : [3] 잔액 조회 실패 알림
    end
    결제관리 ->> 데이터베이스 : [4] 잔액 정보 조회
    데이터베이스 -->> 결제관리 : [5] 잔액 정보 반환
    결제관리 -->> 사용자 : [6] 잔액 정보 전달
```

***

{% hint style="info" %}
**잔액 충전**
{% endhint %}

```mermaid
sequenceDiagram
    actor 사용자
    participant 결제관리
    participant 데이터베이스

    사용자 ->> 결제관리 : [1] 잔액 충전 요청
    결제관리 ->> 데이터베이스 : [2] 충전 가능 여부 확인
    opt 충전 불가
        결제관리 -->> 사용자 : [3] 충전 실패 알림
    end
    결제관리 ->> 데이터베이스 : [4] 충전 처리
    데이터베이스 -->> 결제관리 : [5] 충전 완료
    결제관리 -->> 사용자 : [6] 충전 성공 알림
```

***

{% hint style="info" %}
**좌석 결제 요청**
{% endhint %}

<figure><img src="../.gitbook/assets/8. 좌석 결제 요청 (1).png" alt=""><figcaption></figcaption></figure>

```mermaid
sequenceDiagram
    actor 사용자
    participant 토큰관리
    participant 결제관리
    participant 예약관리
    participant 데이터베이스

    사용자 ->> 토큰관리 : [1] 대기열 토큰 검증 요청
    opt 토큰 검증 실패
        토큰관리 -->> 사용자 : [2] 검증 실패 알림
    end
    토큰관리 ->> 사용자 : [3] 만료시간 갱신

    사용자 ->> 결제관리 : [4] 결제 요청 (좌석 정보 포함)
    결제관리 ->> 예약관리 : [5] 좌석 상태 확인 요청
    예약관리 ->> 데이터베이스 : [6] 좌석 상태 확인 (배정 만료 여부)
    opt 좌석 배정 만료
        데이터베이스 -->> 예약관리 : [7] 좌석 배정 만료 알림
        예약관리 -->> 결제관리 : [8] 좌석 상태 유효하지 않음
        결제관리 -->> 사용자 : [9] 결제 실패 알림 (좌석 만료)
    end

    결제관리 ->> 데이터베이스 : [10] 사용자 잔액 조회
    데이터베이스 -->> 결제관리 : [11] 사용자 잔액 조회 결과

    opt 잔액 부족
        결제관리 -->> 사용자 : [12] 잔액 부족 알림 및 충전 요청
        사용자 ->> 결제관리 : [13] 충전 완료 후 재시도
    end

    결제관리 ->> 데이터베이스 : [14] 결제 금액 차감
    데이터베이스 -->> 결제관리 : [15] 결제 완료
    결제관리 -->> 예약관리 : [16] 결제 성공 알림

    예약관리 ->> 데이터베이스 : [17] 좌석 소유권 사용자에게 배정
    데이터베이스 -->> 예약관리 : [18] 배정 완료
    예약관리 -->> 사용자 : [19] 좌석 배정 및 결제 성공 알림



```
